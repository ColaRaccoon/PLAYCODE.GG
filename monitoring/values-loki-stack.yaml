# Helm values for Loki Stack (Loki + Promtail)
# 설치: helm install loki grafana/loki-stack -n monitoring -f values-loki-stack.yaml
#
# 사전 준비:
#   helm repo add grafana https://grafana.github.io/helm-charts
#   helm repo update

loki:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "125m"
  config:
    # 데이터 보존 기간
    table_manager:
      retention_deletes_enabled: true
      retention_period: 168h  # 7일
    limits_config:
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20
      max_streams_per_user: 10000
      max_entries_limit_per_query: 5000

promtail:
  enabled: true
  resources:
    requests:
      memory: "32Mi"
      cpu: "25m"
    limits:
      memory: "64Mi"
      cpu: "50m"
  config:
    snippets:
      # playcode 네임스페이스 로그에 추가 라벨 부여
      pipelineStages:
        - cri: {}
        - match:
            selector: '{namespace="playcode"}'
            stages:
              # JSON 로그 파싱 (pino 구조화 로그)
              - json:
                  expressions:
                    level: level
                    msg: msg
                    req_method: req.method
                    req_url: req.url
                    res_status: res.statusCode
                    response_time: responseTime
              - labels:
                  level:
                  req_method:

grafana:
  enabled: false  # kube-prometheus-stack에서 이미 설치됨, 데이터소스만 추가

# Loki 데이터소스의 isDefault를 false로 설정 (Prometheus가 기본 데이터소스)
loki:
  isDefault: false
