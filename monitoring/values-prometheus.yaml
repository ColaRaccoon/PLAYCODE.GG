# Helm values for kube-prometheus-stack
# 설치: helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring -f values-prometheus.yaml
#
# 사전 준비:
#   helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
#   helm repo update

prometheus:
  prometheusSpec:
    # EC2 단일 노드 환경에 맞는 리소스 설정 (경량화)
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "250m"

    # 데이터 보존 기간
    retention: 15d
    retentionSize: "5GB"

    # 영구 저장소 (Pod 재시작 시 데이터 유지)
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    # 모든 네임스페이스의 ServiceMonitor 수집
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorNamespaceSelector:
      matchNames:
        - playcode
        - monitoring

    # 추가 스크래핑 설정
    additionalScrapeConfigs:
      # Node Exporter (호스트 메트릭)
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

grafana:
  # 관리자 계정 (Secret으로 관리 권장)
  adminUser: admin
  adminPassword: changeme  # 배포 시 Secret에서 주입

  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "100m"

  # 영구 저장소 (대시보드/설정 유지)
  persistence:
    enabled: true
    size: 2Gi

  # Grafana 서비스 타입
  service:
    type: ClusterIP

  # Ingress 설정 (외부 접근용)
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - grafana.playcode.gg
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.playcode.gg

  # 데이터소스 자동 설정
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-kube-prometheus-prometheus:9090
          access: proxy
          isDefault: true
        - name: Loki
          type: loki
          url: http://loki:3100
          access: proxy
          isDefault: false

  # 대시보드 프로비저닝 (ConfigMap에서 로드)
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'playcode'
          orgId: 1
          folder: 'PlayCode'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/playcode

  dashboardsConfigMaps:
    playcode: "grafana-dashboards-playcode"

# Alertmanager 설정
alertmanager:
  alertmanagerSpec:
    resources:
      requests:
        memory: "32Mi"
        cpu: "25m"
      limits:
        memory: "64Mi"
        cpu: "50m"

# 불필요한 컴포넌트 비활성화 (EC2 단일 노드 리소스 절약)
kubeEtcd:
  enabled: false
kubeScheduler:
  enabled: false
kubeControllerManager:
  enabled: false
