name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# PR 동시 배포 방지
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: playcode-app
  IMAGE_TAG: ${{ github.sha }}

permissions:
  id-token: write   # GitHub OIDC 토큰 발급용
  contents: read

jobs:
  ############################################################
  # 1단계: 코드 품질 검사
  ############################################################
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Kubernetes manifests
        uses: instrumenta/kubeval-action@master
        with:
          files: k8s/

  ############################################################
  # 2단계: 보안 스캔
  ############################################################
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

  ############################################################
  # 3단계: Docker 빌드 + ECR 푸시 + 이미지 스캔
  ############################################################
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: security-scan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # GitHub OIDC로 AWS 인증 (정적 키 대신 임시 자격 증명)
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.source=${{ github.repository }}" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 빌드된 이미지에 대한 Trivy 컨테이너 취약점 스캔
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          ignore-unfixed: true

  ############################################################
  # 4단계: 프로덕션 배포
  ############################################################
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment: production  # GitHub 환경 보호 규칙 (승인 게이트)

    steps:
      - name: Deploy to K8S via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "=== 배포 시작: ${{ env.IMAGE_TAG }} ==="

            # 현재 리비전 저장 (롤백용)
            CURRENT_REVISION=$(kubectl rollout history deployment/playcode-app -n playcode --revision=0 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "현재 리비전: $CURRENT_REVISION"

            # 이미지 업데이트
            kubectl set image deployment/playcode-app \
              playcode-app=925216255375.dkr.ecr.ap-northeast-2.amazonaws.com/playcode-app:${{ github.sha }} \
              -n playcode

            # 배포 상태 확인 (타임아웃 5분)
            if ! kubectl rollout status deployment/playcode-app -n playcode --timeout=300s; then
              echo "=== 배포 실패! 자동 롤백 실행 ==="
              kubectl rollout undo deployment/playcode-app -n playcode
              kubectl rollout status deployment/playcode-app -n playcode --timeout=120s
              echo "=== 롤백 완료 ==="
              exit 1
            fi

            echo "=== 배포 완료 ==="

            # 배포 후 헬스체크
            sleep 10
            HEALTH_STATUS=$(kubectl exec deployment/playcode-app -n playcode -- wget -qO- http://localhost:3000/health 2>/dev/null || echo '{"status":"error"}')
            echo "헬스체크 결과: $HEALTH_STATUS"

  ############################################################
  # 배포 실패 시 알림
  ############################################################
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, security-scan, build, deploy]
    if: failure()
    steps:
      - name: Report failure
        run: |
          echo "::error::파이프라인 실패 — ${{ github.workflow }} (run #${{ github.run_number }})"
          echo "커밋: ${{ github.sha }}"
          echo "브랜치: ${{ github.ref_name }}"
          echo "작성자: ${{ github.actor }}"
