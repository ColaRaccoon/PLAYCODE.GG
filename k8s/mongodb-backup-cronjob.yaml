################################################################################
# MongoDB 자동 백업 CronJob — 매일 S3에 덤프 업로드
################################################################################

apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: playcode
  labels:
    app: mongodb-backup
spec:
  # 매일 새벽 3시 (KST) = 매일 18:00 UTC
  schedule: "0 18 * * *"
  # 동시 실행 금지
  concurrencyPolicy: Forbid
  # 실패 시 기록 보존
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      # 실패 시 1회 재시도
      backoffLimit: 1
      # 최대 실행 시간 30분
      activeDeadlineSeconds: 1800
      template:
        metadata:
          labels:
            app: mongodb-backup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: mongodb-backup
              image: mongo:7
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  # 백업 파일명 (날짜 기반)
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_DIR="/tmp/backup_${TIMESTAMP}"
                  BACKUP_FILE="playcode_backup_${TIMESTAMP}.gz"

                  echo "=== MongoDB 백업 시작: ${TIMESTAMP} ==="

                  # mongodump 실행 (모든 DB 백업)
                  mongodump \
                    --host=mongodb-service:27017 \
                    --username=admin \
                    --password="${MONGO_PASSWORD}" \
                    --authenticationDatabase=admin \
                    --out="${BACKUP_DIR}"

                  echo "=== 덤프 완료, 압축 시작 ==="

                  # tar.gz 압축
                  cd /tmp
                  tar czf "${BACKUP_FILE}" "backup_${TIMESTAMP}"

                  echo "=== 압축 완료 ($(du -h ${BACKUP_FILE} | cut -f1)), S3 업로드 시작 ==="

                  # AWS CLI로 S3 업로드
                  # AWS CLI가 없는 경우 별도 이미지 사용 필요
                  # 아래는 curl + S3 Presigned URL 방식의 대안
                  if command -v aws &> /dev/null; then
                    aws s3 cp "/tmp/${BACKUP_FILE}" \
                      "s3://${S3_BUCKET}/mongodb-backups/${BACKUP_FILE}" \
                      --storage-class STANDARD_IA
                    echo "=== S3 업로드 완료: s3://${S3_BUCKET}/mongodb-backups/${BACKUP_FILE} ==="
                  else
                    echo "AWS CLI 미설치. 로컬 볼륨에 백업 보관."
                    cp "/tmp/${BACKUP_FILE}" "/backups/${BACKUP_FILE}"
                  fi

                  # 임시 파일 정리
                  rm -rf "${BACKUP_DIR}" "/tmp/${BACKUP_FILE}"

                  echo "=== 백업 완료 ==="
              env:
                - name: MONGO_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: playcode-secrets
                      key: MONGO_INITDB_ROOT_PASSWORD
                - name: S3_BUCKET
                  value: "playcode-backups"
                - name: AWS_DEFAULT_REGION
                  value: "ap-northeast-2"
                # AWS 자격 증명 (IRSA 사용 권장, 불가능 시 Secret)
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: playcode-secrets
                      key: AWS_ACCESS_KEY_ID
                      optional: true
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: playcode-secrets
                      key: AWS_SECRET_ACCESS_KEY
                      optional: true
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "200m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              volumeMounts:
                - name: backup-volume
                  mountPath: /backups
          volumes:
            - name: backup-volume
              emptyDir:
                sizeLimit: 5Gi
